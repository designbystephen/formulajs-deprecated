var Formula=Class.create({version:"0.0.12",Options:{defaultMessage:"Errors on this form are marked in red",ignoreValidation:!1},initialize:function(){Element.addMethods(this.Element);for(f in this.Array)Array.prototype[f]=this.Array[f];document.observe("dom:loaded",function(){Formula.load()})},load:function(){this.prepareForms();var e=document.createElement("input");"placeholder"in e||this.preparePlaceholders()},preparePlaceholders:function(){function e(){this.value==this.readAttribute("formula_placeholder")&&(this.value="",this.removeClassName("formula-placeholder"))}function r(){""==this.value&&(this.value=this.readAttribute("formula_placeholder"),this.addClassName("formula-placeholder"))}$$("input[placeholder]").each(function(n){n.writeAttribute({formula_placeholder:n.readAttribute("placeholder")}),n.value=n.readAttribute("placeholder"),n.addClassName("formula-placeholder"),$w("click drop focus").each(function(r){n.observe(r,e.bind(n))}),n.observe("blur",r.bind(n)),n.up("form",0).observe("submit",e.bind(n)),n.up("form",0).observe("reset",function(){function e(){n.value=n.readAttribute("formula_placeholder"),n.addClassName("formula-placeholder")}e.defer()})})},log:function(e){if("undefined"==typeof console){var r=new Error("formula.js: "+e);throw r}console.log(e)},setup:function(e){Formula.Options=Formula.mate(Formula.Options,e)},showErrorMessage:function(e){e[0].ind.scrollTo();var r=e[0].msg+"\r\n"+Formula.Options.defaultMessage;alert(r)},prepareForms:function(){$$("form").length<1&&Formula.log("No forms exist on this page"),$$("form").each(function(e){function r(r){function n(){e.valid?e.submit():Formula.showErrorMessage(e.errors)}Event.stop(r),e.valid=!0,e.errors=[],e.fire("Formula:validate"),n.defer()}e._ignoreValidation=e._ignoreValidation||!1,e.valid=!0,e.observe("submit",r.bind(this)),e._validateHandler=r,e.observe("reset",function(){function r(){e.fire("Formula:reset")}r.defer()})})},Validation:Class.create({initialize:function(element,func,defaultMsg,options){element=$(element),options=options||{};var form;if(form=element.isType("form")?element:element.up("form",0)||null,!form)return Formula.log("No form present for Validation element"),null;var _options={cond:!0,msg:null,ind:null,useControl:!1};options=Formula.mate(_options,options);var titleMsg=function(e){return e?'Please correct an error with "'+e+'"':!1};return options.msg=options.msg||titleMsg(element.title)||defaultMsg,options.ind&&(options.ind=$(options.ind)),options.ind||(options.useControl?options.ind=element:$$("label").each(function(e){e.htmlFor==element.id&&(options.ind=e)})),options.ind?(form.observe("Formula:validate",function(){if(!Formula.Options.ignoreValidation&&!form._ignoreValidation){if(!element.displayed())return void form.unmarkError(options.ind);if(Object.isString(options.cond)&&eval(options.cond)===!1)return void form.unmarkError(options.ind);if(Object.isFunction(options.cond)&&options.cond()===!1)return void form.unmarkError(options.ind);Object.isFunction(func)?func()?form.unmarkError(options.ind):(form.valid=!1,form.markError(options.ind,options.msg)):1!=eval(func)?(form.valid=!1,form.markError(options.ind,options.msg)):form.unmarkError(options.ind)}}),form.observe("Formula:reset",function(){form.unmarkError(options.ind)}),element):(Formula.log("Formula.Validation: an error indicator was not specified"),null)}}),Unveil:Class.create({initialize:function(e,r,n,o,t){e=$(e),r=$(r),_options={veil:!1},t=Formula.mate(_options,t||{});var i=function(){n()?t.veil?r.hide():r.show():t.veil?r.show():r.hide()};i(),e.observe(o,function(){i()});var l=r.up("form",0)||null;return l?void l.observe("Formula:reset",function(){i()}):(Formula.log("Unveil No form present for Unveil container"),null)}}),mate:function(e,r){var n=e;for(var o in r)n[o]=r[o];return n},Element:{toggleUpdate:function(e,r){return e.innerText!=r?(e._innerText=e.innerText,e.innerText=r):e.innerText=e._innerText,e},displayed:function(e){var r=!0;return e.ancestors().each(function(e){"none"!=e.style.display.toLowerCase()&&"hidden"!=e.style.visibility.toLowerCase()&&e.offsetWidth>0&&e.offsetHeight>0||(r=!1)}),r},isType:function(e,r){e=$(e);var n;if(n="input"!=e.tagName.toLowerCase()?e.tagName.toLowerCase():e.type.toLowerCase(),$w(r).length>1&&(r=$w(r)),Object.isArray(r)){var o=!1;return r.each(function(e){e.toLowerCase()==n&&(o=!0)}),o}return n===r.toLowerCase()},textRequire:function(e,r){if(e=$(e),r=r||{},!e.isType("text textarea password"))return Formula.log("Element.textRequire requires a valid textbox, password or textarea element"),null;var n=function(){return""==$F(e)?!1:!0};return new Formula.Validation(e,n,"A required textbox is blank",r),e},regexpRequire:function(e,r,n){if(e=$(e),n=n||{},!e.isType("text textarea"))return Formula.log("Element.regexRequire requires a valid textbox or textarea element"),null;try{r=new RegExp(r)}catch(o){return Formula.log("Element.regexRequire regexp is not a valid Regular Expression"),null}var t=function(){return r.test($F(e))};return new Formula.Validation(e,t,"A textbox is in invalid format",n),e},selectRequire:function(e,r,n){if(e=$(e),n=n||{},!e.isType("select"))return Formula.log("Element.selectRequire requires a valid select element"),null;var o=function(){return r=r||0,Object.isString(r)?e.options[e.selectedIndex].text!=r:Object.isNumber(r)?e.selectedIndex!=r:void 0};return new Formula.Validation(e,o,"A required dropdownlist is unchanged",n),e},checkRequire:function(e,r){if(e=$(e),r=r||{},!e.isType("checkbox"))return Formula.log("Element.checkRequire requires a valid checkbox element"),null;var n=function(){return e.checked};return new Formula.Validation(e,n,"A required checkbox is unchecked",r),e},checkGroupRequire:function(element,req,ind,options){if(element=$(element),options=options||{},!ind)return Formula.log("Element.checkGroupRequire() requires an indicator argument"),null;if(options.ind=ind,null==element)return Formula.log("Element.checkGroupRequire() requires a container element"),null;var f=function(){var cbCount=0;if(element.select('input[type~="checkbox"]').each(function(e){e.checked&&(cbCount+=1)}),Object.isString(req)){var check=eval(cbCount+req);return 1==check||0==check?check:(Formula.log("String based condition not found for Element.checkGroupRequire()"),!0)}return Object.isNumber(req)?cbCount>=req:(new Formula.Req(element,f,options),element)};return new Formula.Validation(element,f,"Required checkbox(es) from a group are unchecked",options),element},radioRequire:function(e,r,n){if(e=$(e),n=n||{},!e.name)return Formula.log("Element.radioRequire requires a radio element with a name"),null;if(!r)return Formula.log("Element.radioRequire requires an indicator argument"),null;n.ind=r;var o=function(){var r=!1;return $$('input[type~="radio"][name~="'+e.name+'"]').each(function(e){e.checked&&(r=!0)}),r};return new Formula.Validation(e,o,"Required radio button group is unchecked",n),name},addCustomValidation:function(e,r,n,o,t){return e=$(e),t=t||{},e.isType("form")||Formula.log("Element.addCustomValidation requires a form element"),t.ind=r,t.msg=n,new Formula.Validation(e,o,"A required custom validator is false",t),e},ignoreValidation:function(e){return e=$(e),e.isType("form")?(e._ignoreValidation=!0,e):(Formula.log("Element.ignoreValidation requires a form element"),null)},escapeValidation:function(e){return e=$(e),e.isType("form")?(e.stopObserving("submit",e._validationHandler),e):(Formula.log("Element.escapeValidation requires a form element"),null)},checkUnveil:function(e,r,n){if(e=$(e),n=n||{},!e.isType("checkbox"))return Formula.log("Element.checkUnveil requires a checkbox element"),null;r||Formula.log("Element.checkUnveil requires a container argument");var o=function(){return e.checked};return new Formula.Unveil(e,r,o,"click",n),e},selectUnveil:function(e,r,n,o){function t(r){return Object.isNumber(r)?e.selectedIndex==r:Object.isString(r)?$F(e)==r:!1}if(e=$(e),n=$(n),o=o||{},e.isType("select")||Formula.log("Element.selectUnveil requires a dropdownlist element"),n||Formula.log("Element.selectUnveil requires a container argument"),Object.isArray(r)&&r.length>0)var i=function(){var e=!1;return r.each(function(r){t(r)&&(e=!0)}),e};else var i=function(){return t(r)};return new Formula.Unveil(e,n,i,"change",o),e},radioUnveil:function(e,r,n){function o(){return e.checked}return e=$(e),r=$(r),e.isType("radio")?(e.observe("click",function(){e.fire("rb:change"),$$('input[type="radio"][name="'+e.name+'"]').each(function(r){r!=e&&r.fire("rb:change")})}),new Formula.Unveil(e,r,o,"rb:change",n),e):(Formula.log("Element.radioUnveil requires a radiobutton element"),null)},addCustomUnveil:function(e,r,n,o,t){return e=$(e),r=$(r),t=t||{},r?e.isType("checkbox select text textarea radio password")?Object.isString(n)?(new Formula.Unveil(e,r,o,n,t),e):(Formula.log("Element.addCustomUnveil requires an event string"),null):(Formula.log("Element.addCustomUnveil requires an input, or textarea as its element"),null):(Formula.log("Element.addCustomUnveil requires a container element"),null)},toggleCheckAll:function(e,r){e=$(e),r=r||{};var n=!0;e.select('input[type~="checkbox"]').each(function(e){e.checked||(n=!1)}),e.select('input[type~="checkbox"]').each(function(e){e.checked=n?!1:!0})},checkGroup:function(element,req,options){function doCheck(event){function reqMet(){if(Object.isNumber(req))return checkCount>=req?!0:!1;if(Object.isString(req)){var check=eval(checkCount+req);return 1==check||0==check?check:(Formula.log("String based condition not found for Element.checkGroup()"),!0)}}Event.stop(event);var checkCount=0;cbs.each(function(e){e.checked&&(checkCount+=1)}),this.checked=reqMet()?!1:!0}if(element=$(element),options=options||{},req=req||1,!element)return Formula.log("Element.checkGroup() requires a container element"),null;var cbs=element.select('input[type~="checkbox"]');return cbs&&0!=cbs.length?(cbs.each(function(e){e.observe("click",doCheck)}),element):(Formula.log("Element.checkGroup() no checkboxes were found"),null)},checkLimit:function(e,r,n){if(e=$(e),n=n||{},r=r||1,!e)return Formula.log("Element.checkGroup() requires a container element"),null;var o=e.select('input[type~="checkbox"]');return o&&0!=o.length?(o.each(function(e){e.observe("click",function(){var n=0;o.each(function(r){r!=e&&r.checked&&(n+=1)}),console.log(n),n+1>r&&(this.checked=!1)})}),e):(Formula.log("Element.checkGroup() no checkboxes were found"),null)},markError:function(e,r,n){!r.hasClassName("formula-error-input")&&r.isType("text textarea select")&&r.toggleClassName("formula-error-input"),r.hasClassName("formula-error-text")||r.isType("text textarea select")||r.toggleClassName("formula-error-text"),"none"==r.style.display&&(r._wasHidden=!0,r.show()),e.errors.push({ind:r,msg:n})},unmarkError:function(e,r){r.removeClassName("formula-error-input"),r.removeClassName("formula-error-text"),r._wasHidden&&(r.style.display="none")}},Array:{checkGroup:function(req,options){function doCheck(event){function reqMet(){if(Object.isNumber(req))return checkCount>=req?!0:!1;if(Object.isString(req)){var check=eval(checkCount+req);return 1==check||0==check?check:(Formula.log("String based condition not found for Element.checkGroup()"),!0)}}Event.stop(event);var checkCount=0;list.each(function(e){e=$(e),e.checked&&(checkCount+=1)}),this.checked=reqMet()?!1:!0}options=options||{},req=req||1;var list=this;return list&&0!=list.length?void list.each(function(e){var e=$(e);return e.isType("checkbox")?void e.observe("click",doCheck):(Formula.log("Array.checkGroup: list items need to be checkboxes"),null)}):(Formula.log("Array.checkGroup() no checkboxes were found"),null)}}});if("undefined"==typeof Prototype)throw"Missing Required Scripts";Formula=new Formula;
